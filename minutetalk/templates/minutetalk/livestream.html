{% extends 'minutetalk/home.html' %} {% block content %} {% load static %}
<v-content>
    <v-container class="videoarea" fluid fill-height>
        <div id="videos">
            <div id="subscriber">
                <div  id="videoDisplay">
                    <h1 id="questionText"></h1>
                    <div id="ratingDisplay">
                        <p> {{partner}} finished answering. Please rate {{partner}}'s answer</p>
                        <i id="thumbs-up" class="fa fa-thumbs-up"></i>
                        <i id="thumbs-down"  class="fa fa-thumbs-down"></i>
                    </div>
                    <div id="rateResult">
                        <p> {{partner}} rated your answer: </p>
                    </div>
                </div>
                
            </div> 
            <div id="publisher"></div>
            <v-list>
                <v-list-tile two-line class="chatname">
                    <v-list-tile-avatar size="40px">
                        <img src="{{partner.img_src.url}}">
                    </v-list-tile-avatar>
                    <v-list-tile-content>
                        <v-list-tile-title class="otherusername">{{partner}}</v-list-tile-title>
                    </v-list-tile-content>
                    <button onclick="vue.alertDisconnect=true"> DISCONNECT</button>

                </v-list-tile>
            </v-list>
            <v-spacer></v-spacer>
        </div>
        <v-container class="questions">

                <div class="pie degree" style="margin-left: 150px;">
                    <span class="block"></span>
                    <span id="time">5</span>
                </div> 

            <div class="question">
                <v-navigation-drawer style="width: 100%">
                     <v-list class="questionlist" two-line>
                        <v-subheader>MY QUESTIONS</v-subheader> 
                        <div id="questionList">
                        {% for question in questions_list%}

                        <v-list-tile  id="{{question.id}}" ripple onclick="sendQuestion('{{question.text}}','{{question.id}}')">
                            <v-list-tile-content>
                                    <p class="myquestion" >{{question.text}}</p>
                                    
                            </v-list-tile-content>
                            <v-list-tile-avatar size="38px">
                                <img src="{{user.userprofile.img_src.url}}">
                            </v-list-tile-avatar>
                        </v-list-tile>
                        {% endfor %}
                        </div>
                        <v-divider></v-divider>

                        <v-subheader>CURRENT QUESTION</v-subheader>
                        <v-list-tile v-if="question" two-line> 
                            <!-- <v-list-tile-avatar size='30px'>
                                <img src='/media/{{partner.img_src}}'>
                            </v-list-tile-avatar> -->
                            
                            <v-list-tile-content >
                                <!-- <small class='timedisplay'> [[question.time]] </small>  -->
                                <v-list-tile-title class='myquestion'> [[question.text]] </v-list-tile-title>
                            </v-list-tile-content>
                        </v-list-tile>

                    </v-list>
                </v-navigation-drawer>
            </div>
        </v-container>
    </v-container>
</v-content>

<v-dialog v-model="disconnect" persistent width="600">
    <v-card>
    <v-card-text style="padding-top: 0px; padding-bottom: 0px;">
        <v-list two-line class="calleeinfo" style="padding-top: 15px;">
            <v-list-tile class="calleedetails" style="padding-left: 0px;">
                <v-list-tile-avatar size="50px" >
                    <img src="{{partner.img_src.url}}">
                </v-list-tile-avatar>
                <v-list-tile-content>
                    <v-list-tile-title>Your call with {{partner}} has been disconnected.</v-list-tile-title>
                    <v-list-tile-sub-title>Don't worry! There are other people back on the channel.</v-list-tile-sub-title>
                </v-list-tile-content>
            </v-list-tile>
      </v-list>
    <v-card-actions>
        <v-spacer></v-spacer>
         <v-btn flat color="indigo darken-4" onclick="redirect()">
      RETURN TO CHANNEL
        </v-btn>
    </v-card-actions>


    </v-card-text>
    </v-card>
</v-dialog>


<v-dialog persistent v-model="alertDisconnect" width="400" >
    <v-card>
    <v-avatar size="80px" class="imagecenter">
        <img src="https://i.ytimg.com/vi/V3M0IWsE8pU/maxresdefault.jpg">
    </v-avatar>
    <v-card-text style="padding-top: 0px; padding-bottom: 0px;">
        <v-list two-line class="calleeinfo">
            <v-list-tile class="calleedetails" style="padding-left: 0px;" >
                <v-list-tile-content style="text-align: center;">
                    <v-list-tile-title style="text-align: center;">Are you sure you want to disconnect?</v-list-tile-title>
                    <v-list-tile-sub-title>{{user.name}} is going to miss you.</v-list-tile-sub-title>
                </v-list-tile-content>
            </v-list-tile>
        </v-list>

        <v-card-actions class="buttons">
             <v-btn flat color="indigo darken-4" onclick="disconnect()">
              YES
            </v-btn>
            <v-spacer></v-spacer>

            <v-btn flat color="red darken-4" @click="alertDisconnect = false">
              NO
            </v-btn>
        </v-card-actions>
            
    </v-card-text>
    </v-card>
</v-dialog>


{% endblock %} 

{% block js %}
<script>
var apiKey = '{{ apikey }}'
var sessionId = '{{ session_id }}'
var token = '{{ token }}'
var partner_id = '{{ partner.id }}'
var channel_id = '{{channel_id}}'

var endpoint = 'ws://' + window.location.host + '/videochat/' + sessionId;
var socket = new WebSocket(endpoint)
var disableButton = false
var answeredQuestion = false

window.onload = function() {
    socket.onmessage = function(e) {
        var data = JSON.parse(e.data)['message']
        if (data['type'] == 'message'){
            if (data['receiver'] == '{{request.user.userprofile.id}}') {
                if(!answeredQuestion){
                    displayQuestion(data, 'YOUR')
                    totaltime = 5
                    setTimeout(function(){
                        console.log('start time')
                        starttime()
                        setTimeout(function(){
                            answeredQuestion = true 
                            displayTimeEnd()
                            // setTimeout 2 seconds
                            // send to partner im done answering, pls rate my answer
                            // data['type'] = rating, data['reciever'] = partner.id,  data['done'] = data['done']

                            setTimeout( function() {
                                console.log('partner rate me now')
                                sendRating('rating', partner_id, data['done'], null)
                            } , 2000);

                            // setTimeout( function() {
                            //     if(!data['done']) {
                            //         sendMessage(vue.question.text, true)
                            //     } else {
                            //         sendDone()
                            //     }
                            // } , 2000);

                        }, totaltime * 1000);    
                    }, 4000);
                } else {
                    sendDone()
                }
            } else {
                displayQuestion(data, '{{partner}}')
            }
        } else if (data['type'] == 'rating'){
            if (data['receiver'] == '{{request.user.userprofile.id}}') {
                console.log('rating....')

                // display rate button
                // after i rated, send rating
                document.getElementById("thumbs-up").onclick = function () { sendRating('rateResult', partner_id, data['done'], true) };
                document.getElementById("thumbs-down").onclick = function () { sendRating('rateResult', partner_id, data['done'], false) };

                document.getElementById('videoDisplay').style.display = 'block'
                document.getElementById('ratingDisplay').style.display = 'block'
                // put onclick function of like button sendRating('rateResult', partner_id, data['done'], rating)
            } 

        } else if (data['type'] == 'rateResult'){
            if (data['receiver'] == '{{request.user.userprofile.id}}') {
                // data['rating']
                document.getElementById('questionText').style.display ='none'
                var el = document.getElementById('rateResult')
                var icon = document.createElement('i');
                el.style.display = 'block'
                if(data['rating']){
                    icon.className = "fa fa-thumbs-up"
                    icon.style.color = "blue"
                } else {
                    icon.className = "fa fa-thumbs-down"
                    icon.style.color = "red"
                }
                el.appendChild(icon)
                

                console.log('{{partner}} rated your question', data['rating'] )

                setTimeout(function(){
                    el.style.display = 'none'
                    if(!data['done']) {
                        sendMessage(vue.question.text, true)
                    } else {
                        sendDone()
                    }
                }, 2000)
            } 

        } else if (data['type'] == 'question_answered'){
            console.log("Question is already answered")
            document.getElementById('videoDisplay').style.display = 'none'
            answeredQuestion = false
            disableButton = false
            document.getElementById('questionList').style="opacity:1"
        } else if (data['type'] == 'disconnect'){
            session.disconnect();
            vue.disconnect = true
        } 
    }
    socket.onopen = function(e) {
        console.log("open", e)
    }
    socket.onerror = function(e) {
        console.log("error", e)
    }
    socket.onclose = function(e) {
        console.log("close", e)
    }
}

// display on top of video
function displayTimeEnd(){
    var display = document.getElementById('videoDisplay')
    var text  = document.getElementById('questionText')
    display.style.display = "block"
   
    text.innerHTML = 'Time is up'
    text.style.display = "block"

    setTimeout(function(){
        // display.style.display = "none"
        // text.style.display = "none"
        text.innerHTML = '{{partner}} is rating your answer'


    }, 2000);
}

function displayQuestion(data, name){
    // disable button of question
    disableButton = true
    document.getElementById('questionList').style="opacity:0.5"

    // display question
    var message = data['message']
    vue.question = {"text": message}
    
    var display = document.getElementById('videoDisplay')
    var text  = document.getElementById('questionText')
    display.style.display = "block"

    text.innerHTML = 'It\'s ' + name + ' turn to answer'
    text.style.display = "block"

    // display whose turn is it, after 2 seconds
    setTimeout(function(){
        text.innerHTML = vue.question.text

        setTimeout(function(){
            display.style.display = "none"
            text.style.display = "none"

        }, 2000);
    }, 2000);
}



function sendQuestion(question_text, question_id) {
    if(!disableButton){
        var element = document.getElementById(question_id)
        element.classList.add("fade-out-right");
        setTimeout(function(){
            element.remove()

        }, 900); 
        sendMessage(question_text, false)
    }
}

function sendMessage(text, done) {
    console.log('Sending message...')
    socket.send(JSON.stringify({
        'type': 'message',
        'receiver': partner_id,
        // 'name': '{{partner}}',
        'done': done,
        'message': text
    }));
}

function sendDone(){
    socket.send(JSON.stringify({
        'type': 'question_answered',
    }))
}

// sendRating('rating', partner_id, data['done'])
function sendRating(socketType, receiver_id, doneValue, rating){
    socket.send(JSON.stringify({
        'type': socketType,
        'receiver': receiver_id,
        'done': doneValue,
        'rating': rating
    }));
    document.getElementById('ratingDisplay').style.display = 'none'

}



    




// timer
var totaltime = 5;
function update(percent) {
    var deg;
    if (percent < (totaltime / 2)) {
        deg = 90 + (360 * percent / totaltime);
        $('.pie').css('background-image',
            'linear-gradient(' + deg + 'deg, transparent 50%, white 50%),linear-gradient(90deg, white 50%, transparent 50%)'
        );
    } else if (percent >= (totaltime / 2)) {
        deg = -90 + (360 * percent / totaltime);
        $('.pie').css('background-image',
            'linear-gradient(' + deg + 'deg, transparent 50%, #00b5e8 50%),linear-gradient(90deg, white 50%, transparent 50%)'
        );
    }
}

function starttime(){
    $('#time').text = totaltime;
    var count = totaltime
    myCounter = setInterval(function () {
        count -= 1;
        if(count<10){
          $('#time').html('0'+count);
        }
        else{
          $('#time').html(count);
        }
        update(count);
        if (count == 0) {
            clearInterval(myCounter);            
        }
    }, 1000);    
}


function handleError(error) {
    if (error) {
        alert(error.message);
    }
}

function disconnect() {
    console.log("Disconnecting");
    session.disconnect();
    // window.history.back();
    redirect()
}

function redirect(){
    window.location.href =  "/" + channel_id
}

function deleteSession() {

}

var session = OT.initSession(apiKey, sessionId);

function initializeSession() {
    // Subscribe to a newly created stream
    session.on('streamCreated', function(event) {
        session.subscribe(event.stream, 'subscriber', {
            insertMode: 'append',
            width: '100%',
            height: '100%'
        }, handleError);
    });
    
    // Listener for diconnected streams
    session.on("streamDestroyed", function(event) {
        session.disconnect();
        // window.history.back();
        // show modal
        vue.disconnect = true
        console.log("Stream " + event.stream.name + " ended. " + event.reason);
    });

    // Create a publisher
    var publisher = OT.initPublisher('publisher', {
        insertMode: 'append',
        width: '100%',
        height: '100%'
    }, handleError);

    // Connect to the session
    session.connect(token, function(error) {
        // If the connection is successful, publish to the session
        if (error) {
            handleError(error);
        } else {
            session.publish(publisher, handleError);
        }
    });
}


// (optional) add server code here
initializeSession();
</script>
{% endblock %}