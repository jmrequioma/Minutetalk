{% extends 'minutetalk/home.html' %} {% block content %} {% load static %}
<v-content>
    <v-container class="videoarea" fluid fill-height>
        <div id="videos">
            <div id="subscriber"></div>
            <div id="publisher"></div>
            <!-- <v-list>
                <v-list-tile two-line :key="user.name" class="chatname">
                    <v-list-tile-avatar size="40px">
                        <img :src="otheruser.avatar">
                    </v-list-tile-avatar>
                    <v-list-tile-content>
                        <v-list-tile-title class="otherusername"></v-list-tile-title>
                    </v-list-tile-content>
                </v-list-tile>
            </v-list> -->
                            <button onclick="disconnect()"> DISCONNECT</button>

            <v-spacer></v-spacer>
        </div>
        <v-container class="questions">

                <div class="pie degree" style="margin-left: 150px;">
                    <span class="block"></span>
                    <span id="time">60</span>
                </div> 

            <div class="question">
                <v-navigation-drawer style="width: 100%">
                     <v-list class="questionlist" two-line>
                        <v-subheader>MY QUESTIONS</v-subheader> 
                        {% for question in questions_list%}
                        <v-list-tile id="{{question.id}}" ripple onclick="removeQuestion('{{question.text}}','{{question.id}}')">
                            <v-list-tile-content>
                                <!-- <v-tooltip top ref="question.id" v-model="show"> -->
                                    <p class="myquestion" >{{question.text}}</p>
                                    <!-- <span>{{question.text}}</span> -->
                                <!-- </v-tooltip> -->
                            </v-list-tile-content>
                            <v-list-tile-avatar size="38px">
                                <img src="/media/{{user.userprofile.img_src}}">
                            </v-list-tile-avatar>
                        </v-list-tile>
                        {% endfor %}
                        <v-divider></v-divider>
                        <v-subheader>INCOMING QUESTIONS</v-subheader>
                        <div id='incoming_messages'></div>

                    </v-list>
                </v-navigation-drawer>
            </div>
        </v-container>
        <!-- <button onclick="sendMessage()"> MESSAGE</button> -->
    </v-container>
</v-content>
{% endblock %} {% block js %}
<script>
var endpoint = 'ws://' + window.location.host + '/videochat/' + sessionId;
var socket = new WebSocket(endpoint)

window.onload = function() {
    socket.onmessage = function(e) {
        var data = JSON.parse(e.data)
        console.log('{{request.user.userprofile.id}}');
        console.log(data['message']['receiver'])
        if (data['message']['receiver'] == '{{request.user.userprofile.id}}') {
            console.log('MESSAGE RECEIVED!')
            var message = data['message']['message']
            var element = "<v-list-tile>" +
                "<v-list-tile-avatar size='30px'>" +
                "<img src='/media/{{partner.img_src}}'>" +
                "</v-list-tile-avatar>" +
                "<v-list-tile-content>" +
                "<small class='timedisplay'>" + '18:23' + "</small>" +
                "<v-list-tile-title class='otherquestion'>" + message + "</v-list-tile-title>" +
                "</v-list-tile-content>" +
                "</v-list-tile>";
            document.getElementById('incoming_messages').innerHTML += (element);        }
    }
    socket.onopen = function(e) {
        console.log("open", e)
    }
    socket.onerror = function(e) {
        console.log("error", e)
    }
    socket.onclose = function(e) {
        console.log("close", e)
    }
}

function removeQuestion(question_text, question_id) {
    var element = document.getElementById(question_id)
    element.classList.add("fade-out-right");
    setTimeout(function(){
        element.remove()
    }, 1 * 900); 
    sendMessage(question_text)
}

function sendMessage(text) {
    console.log('Sending message...')
    socket.send(JSON.stringify({
        'receiver': partner_id,
        'message': text
    }));
}


function handleError(error) {
    if (error) {
        alert(error.message);
    }
}

function disconnect() {
    deleteSession()
    session.disconnect();
    window.history.back();
}

var session = OT.initSession(apiKey, sessionId);

function initializeSession() {
    // Subscribe to a newly created stream
    session.on('streamCreated', function(event) {
        session.subscribe(event.stream, 'subscriber', {
            insertMode: 'append',
            width: '100%',
            height: '100%'
        }, handleError);
    });
    
    // Listener for diconnected streams
    session.on("streamDestroyed", function(event) {
        deleteSession();
        session.disconnect();
        window.history.back();
        console.log("Stream " + event.stream.name + " ended. " + event.reason);
    });

    // Create a publisher
    var publisher = OT.initPublisher('publisher', {
        insertMode: 'append',
        width: '100%',
        height: '100%'
    }, handleError);

    // Connect to the session
    session.connect(token, function(error) {
        // If the connection is successful, publish to the session
        if (error) {
            handleError(error);
        } else {
            session.publish(publisher, handleError);
        }
    });
}

function deleteSession(){
    $.ajax({
        url: '/ajax/delete_session',
        data: {
        },
        success: response => {
        }
    })
}
// (optional) add server code here
initializeSession();
</script>
{% endblock %}